# Точность таймера

[Оригинал статьи](http://www.nczonline.net/blog/2011/12/14/timer-resolution-in-browsers/) на сайте Николаса Закаса.

Точность таймера (в оригинальной статье — разрешение) определяет, как часто обновляются внутренние часы. Исторически сложилось так, что браузеры используют системный таймер для таких функций, как setTimeout() и setInterval(). Это означает, что точность выполнения кода по расписанию в браузерах не может превышать точность системного таймера. Кроме того, Internet Explorer использует системный таймер для установки значений в объекте Date, таким образом разница между объектами даты зависит от точности системного таймера.

## Немного истории

По умолчанию точность таймера в windows находится в пределах в 10…15.6 миллисекунда (чаще всего — 15.6 мс), а значит браузеры вынуждены работать с такой же точностью. Естественно, вы получите точность в 10…15.6 мс в случае, если ваш процессор достаточно современный и быстрый. Думаю, вас не удивит, что IE до восьмой версии включительно использует только системный таймер, и это даже  побудило Джона Ресига [написать статью](http://ejohn.org/blog/accuracy-of-javascript-time/) о том, как точность таймера влияет на различные тесты. В Mac OS X  точность таймера существенно выше, чем в Windows.

До недавнего времени все остальные браузеры, работающие в Windows также использовали системный таймер и были вынуждены довольствоваться точностью в 15.6 миллисекунд. Так делали Firefox, Safari и Opera.Chrome был первым браузером на Windows, который перешёл на работу с [таймером более высокой точности](http://www.belshe.com/2010/06/04/chrome-cranking-up-the-clock/), и этот эксперимент принёс интересные результаты.

Изначально, в Chrome задумывали использовать таймер с точностью в доли миллисекунды, но от этого пришлось отказаться в пользу точности таймера в одну миллисекунду. Было решено использовать вместо системеного таймер из Windows multimedia API, который позволяет использовать точность в одну миллисекунду. Этот таймер используется в плагинах для поддержки Flash и QuickTime.

В бета-версии Chrome 1.0 использовался таймер с точностью в одну миллисекунду. Это прекрасно работало, но в вскоре стало поступать множество отчётов об ошибках. Причиной было то, что повышенная точность таймера заставляла процессор постоянно работать вхолостую, а когда процессор занят он потребляет больше энергии, поскольку не может перейти в спящий режим. Поэтому в Chrome были вынуждены понизить точность таймера до 4 мс.

Точность в 4 мс была зафиксирована в HTML5 как часть [раздела Таймеры](http://www.whatwg.org/specs/web-apps/current-work/multipage/timers.html#timers). Этот раздел определяет точность для setTimeout() в 4 мс. Для setInterval() определена минимальная точность в 10 миллисекунд.

## Как обстоят дела сейчас

Internet Explorer 9, Firefox 5, Safari 5.1 и Opera 11 используют точность таймера в 4 мс, следуя за Chrome. До этого, Firefox 4 и Safari 5 использовали точность в 10 мс (в случае с Safari, возможно, это было жёстко зашито в WebKit). Мобильная версия Safari на iOS 5 также использует точность в 4 мс, а Silk в Kindle Fire — 10 мс, что косвенно указывает на то, что он был основан на более старой версии WebKit. Тем не менее, то, что современные браузеры используют точность таймера в 4 миллисекунды, вовсе не означает, что вы всегда можете получить подобную точность.

Большинство браузеров изменяют точность тамера в зависимости от разных условий. Цель регулировки — увеличение времени работы от батареи, когда это возможно — например, когда, теоретически, вы либо не заметите разницы, либо сделаете выбор в пользу большего времени работы от батарей на ноутбуке или мобильном устройстве. Вот несколько случаев, при которых браузеры изменяют точность таймера:

* Chrome и Internet Explorer, начиная с 9-й версии, переключаются на работу с системным таймером, если ноутбук работает от батарей. Когда подключается внешнее питание, браузеры снова возвращаются к работе с точностью в 4 мс.
* Firefox 5 и старше, Chrome 11 и старше, а также IE 10 [снижают точность таймера в неактивной вкладке](https://bugzilla.mozilla.org/show_bug.cgi?id=633421) до 1000 мс.
* Мобильный Safari в iOS 5 и Silk на Kindle Fire «замораживают» таймер, если вы переключаетесь в другое приложение. Таймер перезапускается, когда вы возвращаетесь обратно в браузер.

Вероятно, браузеры будут и далее изменять точность таймера для снижения энергопотребления в устройствах, работающих от батарей. Спецификация HTML 5 позволяет производителям делать подобные изменения.
 

## Заключение

За последние несколько лет точность таймера почти не обсуждалась, а в это время браузеры довольно сильно изменились. Сама по себе теме точности таймера не предполагает частых и бурных дискуссий, но если вы используете setTimeout() и setInterval(), важно иметь понимание того, как это работает. Мы приблизились к точке, когда будет возможно управлять браузером с точностью в доли миллисекунд. Как только кто-нибудь научится управлять таймером, не создавая при этом нагрузки на центральный процессор, мы получим следующее увеличние точности таймера. Пока же, имейте в виду, что максимальная точность составляет 4 мс, но помните, что вы далеко не всегда можете рассчитывать на подобную точность.